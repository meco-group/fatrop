

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="./">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Fatrop CasADi Cookbook &mdash; Fatrop Documentation</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="_static/css/theme.css?v=9edc463e" />

  
      <script src="_static/jquery.js?v=5d32c60e"></script>
      <script src="_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="_static/documentation_options.js?v=f2a433a1"></script>
      <script src="_static/doctools.js?v=fd6eb6e6"></script>
      <script src="_static/sphinx_highlight.js?v=6ffebe34"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="prev" title="Getting Started" href="getting_started.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            Fatrop
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="getting_started.html">Getting Started</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Fatrop CasADi Cookbook</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#problem-setup-and-dynamics">1. Problem Setup and Dynamics</a></li>
<li class="toctree-l2"><a class="reference internal" href="#constraints-and-objective">2. Constraints and Objective</a></li>
<li class="toctree-l2"><a class="reference internal" href="#problem-dimensions-and-opti-setup">3. Problem Dimensions and Opti Setup</a></li>
<li class="toctree-l2"><a class="reference internal" href="#constraints-objective-and-initial-guess">4. Constraints, Objective, and Initial Guess</a></li>
<li class="toctree-l2"><a class="reference internal" href="#solving-with-ipopt">5. Solving with Ipopt</a></li>
<li class="toctree-l2"><a class="reference internal" href="#solving-with-fatrop">5. Solving with Fatrop</a></li>
<li class="toctree-l2"><a class="reference internal" href="#results-and-visualization">6. Results and Visualization</a></li>
<li class="toctree-l2"><a class="reference internal" href="#advanced-usage-and-performance-considerations">Advanced Usage and Performance Considerations</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#expanding-functions">Expanding Functions</a></li>
<li class="toctree-l3"><a class="reference internal" href="#just-in-time-jit-compilation-of-functions">Just-in Time (JIT) Compilation of Functions</a></li>
<li class="toctree-l3"><a class="reference internal" href="#code-generation">Code Generation</a></li>
<li class="toctree-l3"><a class="reference internal" href="#further-references">Further References</a></li>
</ul>
</li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Fatrop</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Fatrop CasADi Cookbook</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/fatrop_casadi_cookbook.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="fatrop-casadi-cookbook">
<h1>Fatrop CasADi Cookbook<a class="headerlink" href="#fatrop-casadi-cookbook" title="Link to this heading"></a></h1>
<p>Fatrop is interfaced with CasADi’s Opti framework, which provides a user-friendly way to define and solve optimization problems.
We’ll walk through the process of setting up and solving a quadcopter trajectory optimization problem, focusing on key aspects and best practices.
This document is based on the example provided in the Fatrop repository, specifically <a class="reference external" href="https://github.com/meco-group/fatrop/blob/main/examples/ocp_quadrotor_example.py">examples/ocp_quadrotor_example.py</a>.
It is not a complete copy of the example, but rather a guide to the key steps involved in using Fatrop with CasADi.</p>
<section id="problem-setup-and-dynamics">
<h2>1. Problem Setup and Dynamics<a class="headerlink" href="#problem-setup-and-dynamics" title="Link to this heading"></a></h2>
<p>First, we import the necessary libraries, define the physical parameters, and set up the dynamics of our quadcopter:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">casadi</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">ca</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="c1"># Physical parameters</span>
<span class="n">m</span> <span class="o">=</span> <span class="mf">1.0</span>
<span class="n">g</span> <span class="o">=</span> <span class="mf">9.81</span>
<span class="n">l</span> <span class="o">=</span> <span class="mf">0.25</span>
<span class="n">kF</span> <span class="o">=</span> <span class="mf">1e-5</span>
<span class="n">kM</span> <span class="o">=</span> <span class="mf">1e-6</span>
<span class="n">Ix</span><span class="p">,</span> <span class="n">Iy</span><span class="p">,</span> <span class="n">Iz</span> <span class="o">=</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.02</span>  <span class="c1"># Diagonal inertia terms</span>

<span class="c1"># rotor limits</span>
<span class="n">omega_min</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="n">omega_max</span> <span class="o">=</span> <span class="mf">600.0</span>
<span class="c1"># orientation limits</span>
<span class="n">phi_min</span> <span class="o">=</span> <span class="o">-</span><span class="n">ca</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">4</span>
<span class="n">phi_max</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">4</span>
<span class="n">theta_min</span> <span class="o">=</span> <span class="o">-</span><span class="n">ca</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">4</span>
<span class="n">theta_max</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">4</span>

<span class="c1"># State variables</span>
<span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">MX</span><span class="o">.</span><span class="n">sym</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">),</span> <span class="n">ca</span><span class="o">.</span><span class="n">MX</span><span class="o">.</span><span class="n">sym</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">),</span> <span class="n">ca</span><span class="o">.</span><span class="n">MX</span><span class="o">.</span><span class="n">sym</span><span class="p">(</span><span class="s1">&#39;z&#39;</span><span class="p">)</span>
<span class="n">vx</span><span class="p">,</span> <span class="n">vy</span><span class="p">,</span> <span class="n">vz</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">MX</span><span class="o">.</span><span class="n">sym</span><span class="p">(</span><span class="s1">&#39;vx&#39;</span><span class="p">),</span> <span class="n">ca</span><span class="o">.</span><span class="n">MX</span><span class="o">.</span><span class="n">sym</span><span class="p">(</span><span class="s1">&#39;vy&#39;</span><span class="p">),</span> <span class="n">ca</span><span class="o">.</span><span class="n">MX</span><span class="o">.</span><span class="n">sym</span><span class="p">(</span><span class="s1">&#39;vz&#39;</span><span class="p">)</span>
<span class="n">phi</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">psi</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">MX</span><span class="o">.</span><span class="n">sym</span><span class="p">(</span><span class="s1">&#39;phi&#39;</span><span class="p">),</span> <span class="n">ca</span><span class="o">.</span><span class="n">MX</span><span class="o">.</span><span class="n">sym</span><span class="p">(</span><span class="s1">&#39;theta&#39;</span><span class="p">),</span> <span class="n">ca</span><span class="o">.</span><span class="n">MX</span><span class="o">.</span><span class="n">sym</span><span class="p">(</span><span class="s1">&#39;psi&#39;</span><span class="p">)</span>
<span class="n">p</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">r</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">MX</span><span class="o">.</span><span class="n">sym</span><span class="p">(</span><span class="s1">&#39;p&#39;</span><span class="p">),</span> <span class="n">ca</span><span class="o">.</span><span class="n">MX</span><span class="o">.</span><span class="n">sym</span><span class="p">(</span><span class="s1">&#39;q&#39;</span><span class="p">),</span> <span class="n">ca</span><span class="o">.</span><span class="n">MX</span><span class="o">.</span><span class="n">sym</span><span class="p">(</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>

<span class="n">state</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">vertcat</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">vx</span><span class="p">,</span> <span class="n">vy</span><span class="p">,</span> <span class="n">vz</span><span class="p">,</span> <span class="n">phi</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">psi</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>

<span class="c1"># Control inputs</span>
<span class="n">w1</span><span class="p">,</span> <span class="n">w2</span><span class="p">,</span> <span class="n">w3</span><span class="p">,</span> <span class="n">w4</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">MX</span><span class="o">.</span><span class="n">sym</span><span class="p">(</span><span class="s1">&#39;w1&#39;</span><span class="p">),</span> <span class="n">ca</span><span class="o">.</span><span class="n">MX</span><span class="o">.</span><span class="n">sym</span><span class="p">(</span><span class="s1">&#39;w2&#39;</span><span class="p">),</span> <span class="n">ca</span><span class="o">.</span><span class="n">MX</span><span class="o">.</span><span class="n">sym</span><span class="p">(</span><span class="s1">&#39;w3&#39;</span><span class="p">),</span> <span class="n">ca</span><span class="o">.</span><span class="n">MX</span><span class="o">.</span><span class="n">sym</span><span class="p">(</span><span class="s1">&#39;w4&#39;</span><span class="p">)</span>
<span class="n">omega</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">vertcat</span><span class="p">(</span><span class="n">w1</span><span class="p">,</span> <span class="n">w2</span><span class="p">,</span> <span class="n">w3</span><span class="p">,</span> <span class="n">w4</span><span class="p">)</span>

<span class="c1"># Define dynamics (state derivatives)</span>
<span class="n">state_dot</span> <span class="o">=</span> <span class="o">...</span>  <span class="c1"># (full dynamics code here)</span>

<span class="c1"># Create CasADi function for dynamics</span>
<span class="n">f_dyn</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="s1">&#39;f&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">state</span><span class="p">,</span> <span class="n">omega</span><span class="p">],</span> <span class="p">[</span><span class="n">state_dot</span><span class="p">])</span><span class="o">.</span><span class="n">expand</span><span class="p">()</span>

<span class="c1"># Create CasADi function for integrator (explicit Euler)</span>
<span class="n">f_intg</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="s1">&#39;f_dyn_discr&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">state</span><span class="p">,</span> <span class="n">omega</span><span class="p">],</span> <span class="p">[</span><span class="n">state</span> <span class="o">+</span> <span class="n">T</span><span class="o">/</span><span class="n">K</span><span class="o">*</span><span class="n">f_dyn</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">omega</span><span class="p">)])</span><span class="o">.</span><span class="n">expand</span><span class="p">()</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The integrator function will be re-used at every time step.
For functions which are used multiple times, it is generally beneficial to put them
in a CasADi function to avoid duplication of expressions.
We use the expanded version of the dynamics function for efficiency.
Refer to the CasADi documentation for more details.</p>
</div>
</section>
<section id="constraints-and-objective">
<h2>2. Constraints and Objective<a class="headerlink" href="#constraints-and-objective" title="Link to this heading"></a></h2>
<p>Define constraints and the objective function:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Control and state constraints</span>
<span class="n">omega_min</span><span class="p">,</span> <span class="n">omega_max</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1000.0</span>
<span class="n">phi_min</span><span class="p">,</span> <span class="n">phi_max</span> <span class="o">=</span> <span class="o">-</span><span class="n">ca</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">3</span><span class="p">,</span> <span class="n">ca</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">3</span>
<span class="n">theta_min</span><span class="p">,</span> <span class="n">theta_max</span> <span class="o">=</span> <span class="o">-</span><span class="n">ca</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">3</span><span class="p">,</span> <span class="n">ca</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">3</span>

<span class="c1"># Initial and final states</span>
<span class="n">x0</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">DM</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
<span class="n">xf</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">DM</span><span class="p">([</span><span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>

<span class="c1"># Path constraints</span>
<span class="n">f_control</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="s1">&#39;f_control&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">state</span><span class="p">,</span> <span class="n">omega</span><span class="p">],</span> <span class="p">[</span><span class="n">ca</span><span class="o">.</span><span class="n">vertcat</span><span class="p">(</span><span class="n">omega</span><span class="p">,</span> <span class="n">phi</span><span class="p">,</span> <span class="n">theta</span><span class="p">)])</span><span class="o">.</span><span class="n">expand</span><span class="p">()</span>
<span class="n">lb_control</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">vertcat</span><span class="p">(</span><span class="n">omega_min</span><span class="o">*</span><span class="n">ca</span><span class="o">.</span><span class="n">DM</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span> <span class="n">phi_min</span><span class="p">,</span> <span class="n">theta_min</span><span class="p">)</span>
<span class="n">ub_control</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">vertcat</span><span class="p">(</span><span class="n">omega_max</span><span class="o">*</span><span class="n">ca</span><span class="o">.</span><span class="n">DM</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span> <span class="n">phi_max</span><span class="p">,</span> <span class="n">theta_max</span><span class="p">)</span>

<span class="c1"># Objective function</span>
<span class="n">f_cost</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="s1">&#39;f_cost&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">omega</span><span class="p">],</span> <span class="p">[</span><span class="n">ca</span><span class="o">.</span><span class="n">sumsqr</span><span class="p">(</span><span class="n">omega</span><span class="o">/</span><span class="n">omega_max</span><span class="p">)])</span><span class="o">.</span><span class="n">expand</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="problem-dimensions-and-opti-setup">
<h2>3. Problem Dimensions and Opti Setup<a class="headerlink" href="#problem-dimensions-and-opti-setup" title="Link to this heading"></a></h2>
<p>Maintain a list of problem dimensions and set up the optimization problem.
For the CasADi’s fatrop interface, it is important to define the optimization variables in a specific order:
x0, u0, x1, u1, …, xK-1, uK-1.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">K</span><span class="p">,</span> <span class="n">T</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span> <span class="mf">5.0</span>  <span class="c1"># Number of control intervals, Total time</span>
<span class="n">nx</span> <span class="o">=</span> <span class="p">[</span><span class="mi">12</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">K</span><span class="p">)]</span> <span class="c1"># number of state variables at each time step</span>
<span class="n">nu</span> <span class="o">=</span> <span class="p">[</span><span class="mi">4</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">K</span><span class="o">-</span><span class="mi">1</span><span class="p">)]</span> <span class="o">+</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># number of control inputs at each time step</span>
<span class="n">ng</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># number of path constraints, rill we populated when setting up constraints</span>

<span class="n">opti</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">Opti</span><span class="p">()</span>
<span class="n">x</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">u</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">K</span><span class="p">):</span>
    <span class="n">x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">opti</span><span class="o">.</span><span class="n">variable</span><span class="p">(</span><span class="n">nx</span><span class="p">[</span><span class="n">k</span><span class="p">]))</span>
    <span class="n">u</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">opti</span><span class="o">.</span><span class="n">variable</span><span class="p">(</span><span class="n">nu</span><span class="p">[</span><span class="n">k</span><span class="p">]))</span>
</pre></div>
</div>
</section>
<section id="constraints-objective-and-initial-guess">
<h2>4. Constraints, Objective, and Initial Guess<a class="headerlink" href="#constraints-objective-and-initial-guess" title="Link to this heading"></a></h2>
<p>Set up constraints, objective, and provide an initial guess.
The constraints should be defined in the following order:
discrete_dynamics_0, path_constraints_0, …, discrete_dynamics_K-2, path_constraints_K-2, path_constraints_K-1</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">ng</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">K</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">K</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">opti</span><span class="o">.</span><span class="n">subject_to</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">discrete_dynamics</span><span class="p">(</span><span class="n">u</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">k</span><span class="p">))</span>
    <span class="n">path_constr</span> <span class="o">=</span> <span class="n">path_constraints</span><span class="p">(</span><span class="n">u</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">k</span><span class="p">)</span>
    <span class="n">ng</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">constr</span> <span class="ow">in</span> <span class="n">path_constr</span><span class="p">:</span>
        <span class="n">ng</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">constr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">nnz</span><span class="p">()</span>
        <span class="n">opti</span><span class="o">.</span><span class="n">subject_to</span><span class="p">((</span><span class="n">constr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">constr</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&lt;=</span> <span class="n">constr</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

<span class="c1"># Objective</span>
<span class="n">J</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">K</span><span class="p">):</span>
    <span class="n">J</span> <span class="o">+=</span> <span class="n">cost</span><span class="p">(</span><span class="n">u</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">k</span><span class="p">)</span>
<span class="n">opti</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="n">J</span><span class="p">)</span>

<span class="c1"># Initial guess</span>
<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">K</span><span class="p">):</span>
    <span class="n">u_init</span><span class="p">,</span> <span class="n">x_init</span> <span class="o">=</span> <span class="n">initial_guess</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
    <span class="n">opti</span><span class="o">.</span><span class="n">set_initial</span><span class="p">(</span><span class="n">u</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">u_init</span><span class="p">)</span>
    <span class="n">opti</span><span class="o">.</span><span class="n">set_initial</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">x_init</span><span class="p">)</span>
</pre></div>
</div>
<p>The <cite>ng</cite> list keeps track of the number of path constraints at each time step, which is important for the manual structure detection when using Fatrop.</p>
</section>
<section id="solving-with-ipopt">
<h2>5. Solving with Ipopt<a class="headerlink" href="#solving-with-ipopt" title="Link to this heading"></a></h2>
<p>Solve the problem using both Ipopt (reference solve):</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Solve with Ipopt</span>
<span class="n">opti</span><span class="o">.</span><span class="n">solver</span><span class="p">(</span><span class="s1">&#39;ipopt&#39;</span><span class="p">,</span> <span class="p">{})</span>
<span class="n">sol_ipopt</span> <span class="o">=</span> <span class="n">opti</span><span class="o">.</span><span class="n">solve</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="solving-with-fatrop">
<h2>5. Solving with Fatrop<a class="headerlink" href="#solving-with-fatrop" title="Link to this heading"></a></h2>
<p>Solve the problem using both Ipopt and Fatrop:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Solve with Fatrop</span>
<span class="n">opti</span><span class="o">.</span><span class="n">solver</span><span class="p">(</span><span class="s1">&#39;fatrop&#39;</span><span class="p">,</span> <span class="p">{</span>
    <span class="s1">&#39;structure_detection&#39;</span><span class="p">:</span> <span class="s1">&#39;manual&#39;</span><span class="p">,</span>
    <span class="s1">&#39;nx&#39;</span><span class="p">:</span> <span class="n">nx</span><span class="p">,</span> <span class="s1">&#39;nu&#39;</span><span class="p">:</span> <span class="n">nu</span><span class="p">,</span> <span class="s1">&#39;ng&#39;</span><span class="p">:</span> <span class="n">ng</span><span class="p">,</span> <span class="s1">&#39;N&#39;</span><span class="p">:</span> <span class="n">K</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span>
    <span class="s2">&quot;expand&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">})</span>
<span class="n">sol_fatrop</span> <span class="o">=</span> <span class="n">opti</span><span class="o">.</span><span class="n">solve</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="results-and-visualization">
<h2>6. Results and Visualization<a class="headerlink" href="#results-and-visualization" title="Link to this heading"></a></h2>
<p>Retrieve and visualize the results:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">X_sol</span> <span class="o">=</span> <span class="n">sol_fatrop</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">ca</span><span class="o">.</span><span class="n">horzcat</span><span class="p">(</span><span class="o">*</span><span class="n">x</span><span class="p">))</span>

<span class="c1"># Visualization code</span>
<span class="c1"># ... (3D trajectory plotting)</span>
</pre></div>
</div>
<p>For the complete visualization code, please refer to the full example in <a class="reference external" href="https://github.com/meco-group/fatrop/blob/main/examples/ocp_quadrotor_example.py">examples/ocp_quadrotor_example.py</a>.</p>
</section>
<section id="advanced-usage-and-performance-considerations">
<h2>Advanced Usage and Performance Considerations<a class="headerlink" href="#advanced-usage-and-performance-considerations" title="Link to this heading"></a></h2>
<section id="expanding-functions">
<h3>Expanding Functions<a class="headerlink" href="#expanding-functions" title="Link to this heading"></a></h3>
<p>To potentially speed up function evaluation, we’ve used expanded functions throughout this example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">f_dyn</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="s1">&#39;f&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">state</span><span class="p">,</span> <span class="n">omega</span><span class="p">],</span> <span class="p">[</span><span class="n">state_dot</span><span class="p">])</span><span class="o">.</span><span class="n">expand</span><span class="p">()</span>
<span class="n">f_cost</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="s1">&#39;f_cost&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">omega</span><span class="p">],</span> <span class="p">[</span><span class="n">ca</span><span class="o">.</span><span class="n">sum1</span><span class="p">((</span><span class="n">omega</span><span class="o">/</span><span class="n">omega_max</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)])</span><span class="o">.</span><span class="n">expand</span><span class="p">()</span>
<span class="n">f_control</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="s1">&#39;f_control&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">state</span><span class="p">,</span> <span class="n">omega</span><span class="p">],</span> <span class="p">[</span><span class="n">ca</span><span class="o">.</span><span class="n">vertcat</span><span class="p">(</span><span class="n">omega</span><span class="p">,</span> <span class="n">phi</span><span class="p">,</span> <span class="n">theta</span><span class="p">)])</span><span class="o">.</span><span class="n">expand</span><span class="p">()</span>
</pre></div>
</div>
<p>Performance might also improve by expanding the full functions, used by fatrop internally.
This can be done by setting the <cite>expand</cite> option to <cite>True</cite> when creating the function.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Solve with Fatrop</span>
<span class="n">opti</span><span class="o">.</span><span class="n">solver</span><span class="p">(</span><span class="s1">&#39;fatrop&#39;</span><span class="p">,</span> <span class="p">{</span>
    <span class="s1">&#39;structure_detection&#39;</span><span class="p">:</span> <span class="s1">&#39;manual&#39;</span><span class="p">,</span>
    <span class="s1">&#39;nx&#39;</span><span class="p">:</span> <span class="n">nx</span><span class="p">,</span> <span class="s1">&#39;nu&#39;</span><span class="p">:</span> <span class="n">nu</span><span class="p">,</span> <span class="s1">&#39;ng&#39;</span><span class="p">:</span> <span class="n">ng</span><span class="p">,</span> <span class="s1">&#39;N&#39;</span><span class="p">:</span> <span class="n">K</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span>
    <span class="s2">&quot;expand&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span>
<span class="n">sol_fatrop</span> <span class="o">=</span> <span class="n">opti</span><span class="o">.</span><span class="n">solve</span><span class="p">()</span>
</pre></div>
</div>
<p>This can speed up the function evaluation, sometimes at the cost of having larger expressions with duplicated code.
These large expressions can result in long compilation times when using code generation / JIT compilation.</p>
</section>
<section id="just-in-time-jit-compilation-of-functions">
<h3>Just-in Time (JIT) Compilation of Functions<a class="headerlink" href="#just-in-time-jit-compilation-of-functions" title="Link to this heading"></a></h3>
<p>CasADi supports Just-in-Time (JIT) compilation, which can significantly speed up the evaluation of functions.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">opti</span><span class="o">.</span><span class="n">solver</span><span class="p">(</span><span class="s1">&#39;fatrop&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;structure_detection&#39;</span><span class="p">:</span><span class="s1">&#39;manual&#39;</span><span class="p">,</span> <span class="s1">&#39;nx&#39;</span><span class="p">:</span> <span class="n">nx</span><span class="p">,</span> <span class="s1">&#39;nu&#39;</span><span class="p">:</span><span class="n">nu</span><span class="p">,</span> <span class="s1">&#39;ng&#39;</span><span class="p">:</span><span class="n">ng</span><span class="p">,</span> <span class="s1">&#39;N&#39;</span><span class="p">:</span><span class="n">K</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;expand&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;jit&quot;</span><span class="p">:</span><span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;jit_options&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;flags&quot;</span><span class="p">:</span> <span class="s2">&quot;-O3&quot;</span><span class="p">,</span> <span class="s2">&quot;verbose&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}})</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">opti</span><span class="o">.</span><span class="n">solve</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="code-generation">
<h3>Code Generation<a class="headerlink" href="#code-generation" title="Link to this heading"></a></h3>
<p>Code generation is a powerful technique to improve the performance of your optimization problem.
CasADi provides tools to generate C code for any CasADi function.
This means that we can put the full solver in a CasADi function and generate C code for it.</p>
<ol class="arabic">
<li><p>Generate C code for the optimization problem:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Generate C code</span>
<span class="n">opti</span><span class="o">.</span><span class="n">to_function</span><span class="p">(</span><span class="s1">&#39;f_quadrotor&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">ca</span><span class="o">.</span><span class="n">horzcat</span><span class="p">(</span><span class="o">*</span><span class="n">x</span><span class="p">),</span> <span class="n">ca</span><span class="o">.</span><span class="n">horzcat</span><span class="p">(</span><span class="o">*</span><span class="n">u</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])],</span> <span class="p">[</span><span class="n">ca</span><span class="o">.</span><span class="n">horzcat</span><span class="p">(</span><span class="o">*</span><span class="n">x</span><span class="p">)],</span> <span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;u&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;X&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="s1">&#39;quadrotor_ocp.c&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;with_header&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span>
</pre></div>
</div>
<p>This generates a C file and header named ‘quadrotor_ocp.(c/h)’ that contains the optimized code/declarations for your problem.</p>
</li>
</ol>
<p>The generated code can be used directly from C/C++ applications, and it’s completely CasADi-free.
This means you can integrate the optimized function into your C/C++ projects without needing CasADi as a dependency.
The generated code can be compiled with:</p>
<blockquote>
<div><div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>gcc<span class="w"> </span>-fPIC<span class="w"> </span>-shared<span class="w"> </span>quadcopter.c<span class="w"> </span>-g<span class="w"> </span>-O3<span class="w"> </span>-march<span class="o">=</span>native<span class="w"> </span>-lfatrop<span class="w"> </span>-lblasfeo<span class="w"> </span>-I<span class="sb">`</span>fatrop<span class="w"> </span>path<span class="sb">`</span><span class="w"> </span>-I<span class="sb">`</span>blasfeo<span class="w"> </span>path<span class="sb">`</span>/include/blasfeo/include
</pre></div>
</div>
</div></blockquote>
<p>This shared library can be imported into casadi using CasADi’s <cite>external</cite> function interface.</p>
<p>For more information refer to the directory <a class="reference external" href="https://github.com/meco-group/fatrop/tree/main/examples/casadi_codegen">examples/casadi_codegen/</a> in the Fatrop repository.</p>
</section>
<section id="further-references">
<h3>Further References<a class="headerlink" href="#further-references" title="Link to this heading"></a></h3>
<dl class="simple">
<dt>For more information on using Fatrop with CasADi, refer to the following resources:</dt><dd><ul class="simple">
<li><p><a class="reference external" href="https://www.youtube.com/watch?v=example">Fatrop CasADi video tutorial on YouTube</a></p></li>
<li><p><a class="reference external" href="https://github.com/jgillis/fatrop_demo">Fatrop CasADi demo Github repo</a></p></li>
<li><p><a class="reference external" href="https://web.casadi.org/">CasADi website</a></p></li>
</ul>
</dd>
</dl>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="getting_started.html" class="btn btn-neutral float-left" title="Getting Started" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Lander Vanroye.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>